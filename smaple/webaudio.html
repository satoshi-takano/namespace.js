<html>
<script type="text/javascript" src="../src/0_lib_define.js"></script>
<script type="text/javascript" src="../src/1_namespace.js"></script>
<script type="text/javascript" src="../src/2_core.js"></script>
<script type="text/javascript" src="../src/3_events.js"></script>
<script type="text/javascript" src="../src/4_geom.js"></script>
<script type="text/javascript" src="../src/5_application.js"></script>
<script type="text/javascript" src="../src/6_tween.js"></script>
<script type="text/javascript" src="../src/7_net.js"></script>
<script type="text/javascript" src="../src/8_display.js"></script>
<script type="text/javascript" src="../src/9_ui.js"></script>
<script type="text/javascript" src="../src/10_native_extention.js"></script>
<script type="text/javascript" src="../src/11_canvas.js"></script>
<script type="text/javascript" src="../src/12_math.js"></script>

<canvas id="canvas" width='500' height='500'>
</canvas>
<script type="text/javascript">

var jsnode;
new Namespace(namespace_lib_core).Main.getInstance().main(function (argument) {
	var ns = new Namespace(namespace_lib_canvas)
	var nsmath = new Namespace(namespace_lib_math);
	var stage = ns.Stage.gen(document.getElementById("canvas"));
	
	var cont = ns.DisplayObjectContainer.gen();
	stage.addChild(cont);
	cont.graphics.beginFill(0);
	cont.graphics.drawRect(0, 0, stage.stageWidth, stage.stageHeight);
	cont.graphics.context.font = "11px Helvetica"
	
	var bufSize = Math.pow(2, 9);
	
	var context = new webkitAudioContext();
	jsnode = context.createJavaScriptNode(bufSize, 0, 1);
	jsnode.connect(context.destination);
	var sampleRate = context.sampleRate;
	
	var real = [];
	var imag = [];
	var phase = 0;
	var c = 0;
	cont.graphics.beginFill(0xff0000, 1);
	function fillBuffer(n, bufL, bufR) {
		var freq = 240 + 220 * Math.sin(c+=0.05);
		var f = freq * 2 * Math.PI / sampleRate;
		cont.draw();
		var x = 0;
		for (var t = 0; t < n; t++) {
			var sample = 0;
			sample = Math.sin(phase);
			sample += 0.5 * Math.sin(phase * 2);
			sample += 0.25 * Math.sin(phase * 3);
			bufL[t] = bufR[t] = sample;
			x = (stage.stageWidth / bufSize) * (t + 1);
			cont.graphics.context.fillRect(x, 250 + bufL[t] * 50, 2, 2);
			phase += f;
		}
	}
	
	var ff = false;
	jsnode.onaudioprocess = function(e) {
		if (ff) return;
		var buf = e.outputBuffer;
		var bufL = buf.getChannelData(0);
		var bufR = buf.getChannelData(1);

		fillBuffer(buf.length, bufL, bufR);
		
		buf.length.times(function (i) {
			real[i] = bufL[i];
			imag[i] = 0;
		})
		var fft = nsmath.FFT.gen(bufSize);
	  fft.fft(real, imag);
		
		var x = 0;
		var step = Math.floor(bufSize / 2 / 10);
		var dx = (stage.stageWidth / step);
		var amp = 0;
		var flg = false;
		for (var i = 0; i <= step; i++) {
			amp = Math.sqrt(real[i] * real[i] + imag[i] + imag[i]);
			var Hz = Math.floor(sampleRate / bufSize * i) / 1;
			cont.graphics.context.fillStyle = "#00ff00";
			cont.graphics.context.fillRect(i * dx, stage.stageHeight - amp, 1, (stage.stageHeight - amp))
			
			cont.graphics.context.fillStyle = "#ffffff";
			cont.graphics.context.fillText(
				i != step ? Math.floor(Hz) : "(Hz)", // text
			 	(i * dx) - (i == 0 ? -2 : 11) - (i == step ? 12 : 0), // x position
			 stage.stageHeight - 15 + ((flg = !flg) ? -7 : 7)) // y position
		}
	}

	stage.draw();
});

</script>
<body>
</body>
</html>

